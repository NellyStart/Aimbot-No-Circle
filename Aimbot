local PLAYER = game.Players.LocalPlayer
local MOUSE = PLAYER:GetMouse()
local CC = game.Workspace.CurrentCamera

ENABLED = false
ESP_ENABLED = false

_G.FREE_FOR_ALL = true

_G.ESP_BIND = 52
_G.CHANGE_AIM = 'q'
_G.AIM_AT = 'Head'
local PRIORITY_DISTANCE = 10 -- Максимальное расстояние для приоритетной цели

wait(1)

-- Функция для проверки количества команд в игре
local function getTeamCount()
    local teams = game:GetService("Teams"):GetTeams()
    return #teams
end

-- Добавляем переменную для хранения текущей приоритетной цели
local priorityTarget = nil

function GetNearestPlayerToMouse()
    local PLAYERS = {}
    local PLAYER_HOLD = {}
    local DISTANCES = {}

    for _, v in pairs(game.Players:GetPlayers()) do
        if v ~= PLAYER then
            table.insert(PLAYERS, v)
        end
    end

    for _, v in pairs(PLAYERS) do
        if getTeamCount() <= 1 or v.TeamColor ~= PLAYER.TeamColor then
            if v and (v.Character ~= nil) then
                local AIM = v.Character:FindFirstChild(_G.AIM_AT)
                if AIM ~= nil then
                    local DISTANCE = (AIM.Position - game.Workspace.CurrentCamera.CoordinateFrame.p).magnitude
                    local RAY = Ray.new(game.Workspace.CurrentCamera.CoordinateFrame.p, (MOUSE.Hit.p - CC.CoordinateFrame.p).unit * DISTANCE)
                    local HIT, POS = game.Workspace:FindPartOnRay(RAY, game.Workspace)
                    local DIFF = math.floor((POS - AIM.Position).magnitude)
                    
                    PLAYER_HOLD[v.Name] = {plr = v, dist = DISTANCE, diff = DIFF}
                    table.insert(DISTANCES, DIFF)
                end
            end
        end
    end

    if #DISTANCES == 0 then
        return false
    end

    local L_DISTANCE = math.floor(math.min(unpack(DISTANCES)))
    if L_DISTANCE > 5 then
        return false
    end

    for _, v in pairs(PLAYER_HOLD) do
        if v.diff == L_DISTANCE then
            return v.plr
        end
    end
    return false
end

local GUI_MAIN = Instance.new('ScreenGui', game.CoreGui)
local GUI_TARGET = Instance.new('TextLabel', GUI_MAIN)
local GUI_AIM_AT = Instance.new('TextLabel', GUI_MAIN)

GUI_MAIN.Name = 'AIMBOT'

GUI_TARGET.Size = UDim2.new(0, 200, 0, 30)
GUI_TARGET.BackgroundTransparency = 0.5
GUI_TARGET.BackgroundColor = BrickColor.new('Fossil')
GUI_TARGET.BorderSizePixel = 0
GUI_TARGET.Position = UDim2.new(0.5, -100, 0, 0)
GUI_TARGET.Text = 'AIMBOT : OFF'
GUI_TARGET.TextColor3 = Color3.new(1, 1, 1)
GUI_TARGET.TextStrokeTransparency = 1
GUI_TARGET.TextWrapped = true
GUI_TARGET.FontSize = 'Size24'
GUI_TARGET.Font = 'SourceSansBold'

GUI_AIM_AT.Size = UDim2.new(0, 200, 0, 20)
GUI_AIM_AT.BackgroundTransparency = 0.5
GUI_AIM_AT.BackgroundColor = BrickColor.new('Fossil')
GUI_AIM_AT.BorderSizePixel = 0
GUI_AIM_AT.Position = UDim2.new(0.5, -100, 0, 30)
GUI_AIM_AT.Text = 'AIMING : HEAD'
GUI_AIM_AT.TextColor3 = Color3.new(1, 1, 1)
GUI_AIM_AT.TextStrokeTransparency = 1
GUI_AIM_AT.TextWrapped = true
GUI_AIM_AT.FontSize = 'Size18'
GUI_AIM_AT.Font = 'SourceSansBold'

local TRACK = false

function CREATE(BASE, TEAM)
    local ESP_MAIN = Instance.new('BillboardGui', PLAYER.PlayerGui)
    local ESP_DOT = Instance.new('Frame', ESP_MAIN)
    local ESP_NAME = Instance.new('TextLabel', ESP_MAIN)

    ESP_MAIN.Name = 'ESP'
    ESP_MAIN.Adornee = BASE
    ESP_MAIN.AlwaysOnTop = true
    ESP_MAIN.ExtentsOffset = Vector3.new(0, 1, 0)
    ESP_MAIN.Size = UDim2.new(0, 5, 0, 5)

    ESP_DOT.Name = 'DOT'
    ESP_DOT.BackgroundColor = BrickColor.new('Bright red')
    ESP_DOT.BackgroundTransparency = 0.3
    ESP_DOT.BorderSizePixel = 0
    ESP_DOT.Position = UDim2.new(-0.5, 0, -0.5, 0)
    ESP_DOT.Size = UDim2.new(2, 0, 2, 0)
    ESP_DOT.Visible = true
    ESP_DOT.ZIndex = 10

    ESP_NAME.Name = 'NAME'
    ESP_NAME.BackgroundColor3 = Color3.new(255, 255, 255)
    ESP_NAME.BackgroundTransparency = 1
    ESP_NAME.BorderSizePixel = 0
    ESP_NAME.Position = UDim2.new(0, 0, 0, -40)
    ESP_NAME.Size = UDim2.new(1, 0, 10, 0)
    ESP_NAME.Visible = true
    ESP_NAME.ZIndex = 10
    ESP_NAME.Font = 'ArialBold'
    ESP_NAME.FontSize = 'Size14'
    ESP_NAME.Text = BASE.Parent.Name:upper()
    ESP_NAME.TextColor = BrickColor.new('Bright red')
end

function CLEAR()
    for _, v in pairs(PLAYER.PlayerGui:children()) do
        if v.Name == 'ESP' and v:IsA('BillboardGui') then
            v:Destroy()
        end
    end
end

function FIND()
    CLEAR()
    TRACK = true
    spawn(function()
        while wait() do
            if TRACK then
                CLEAR()
                for _, v in pairs(game.Players:GetChildren()) do
                    if v.Character and v.Character:FindFirstChild('Head') then
                        if getTeamCount() <= 1 or v.TeamColor ~= PLAYER.TeamColor then
                            if v.Character:FindFirstChild('Head') then
                                CREATE(v.Character.Head, true)
                            end
                        end
                    end
                end
            end
        end
        wait(1)
    end)
end

MOUSE.Button2Down:connect(function()
    ENABLED = true
end)

MOUSE.Button2Up:connect(function()
    ENABLED = false
    priorityTarget = nil -- Сбрасываем приоритетную цель, когда отключаем Aimbot
end)

MOUSE.KeyDown:connect(function(KEY)
    KEY = KEY:lower():byte()
    if KEY == _G.ESP_BIND then
        if ESP_ENABLED == false then
            FIND()
            ESP_ENABLED = true
            print('ESP : ON')
        elseif ESP_ENABLED == true then
            wait()
            CLEAR()
            TRACK = false
            ESP_ENABLED = false
            print('ESP : OFF')
        end
    end
end)

MOUSE.KeyDown:connect(function(KEY)
    if KEY == _G.CHANGE_AIM then
        if _G.AIM_AT == 'Head' then
            _G.AIM_AT = 'Torso'
            GUI_AIM_AT.Text = 'AIMING : TORSO'
        elseif _G.AIM_AT == 'Torso' then
            _G.AIM_AT = 'Head'
            GUI_AIM_AT.Text = 'AIMING : HEAD'
        end
    end
end)

game:GetService('RunService').RenderStepped:connect(function()
    if ENABLED then
        local nearestPlayer = GetNearestPlayerToMouse()
        
        -- Если приоритетная цель установлена
        if priorityTarget and priorityTarget.Character and priorityTarget.Character:FindFirstChild(_G.AIM_AT) then
            local AIM = priorityTarget.Character:FindFirstChild(_G.AIM_AT)
            local DISTANCE_TO_PRIORITY = (AIM.Position - CC.CFrame.p).magnitude
            
            if DISTANCE_TO_PRIORITY <= PRIORITY_DISTANCE then
                -- Если приоритетная цель в пределах допустимого расстояния, наводимся на неё
                CC.CoordinateFrame = CFrame.new(CC.CoordinateFrame.p, AIM.CFrame.p)
                GUI_TARGET.Text = 'AIMBOT : ' .. priorityTarget.Name:sub(1, 5)
                return
            else
                -- Если приоритетная цель вне радиуса, сбрасываем её
                priorityTarget = nil
            end
        end
        
        -- Если приоритетная цель не установлена или вне радиуса, устанавливаем ближайшую игрока
        if nearestPlayer then
            priorityTarget = nearestPlayer
            local AIM = nearestPlayer.Character:FindFirstChild(_G.AIM_AT)
            if AIM then
                CC.CoordinateFrame = CFrame.new(CC.CoordinateFrame.p, AIM.CFrame.p)
                GUI_TARGET.Text = 'AIMBOT : ' .. nearestPlayer.Name:sub(1, 5)
            end
        else
            GUI_TARGET.Text = 'AIMBOT : OFF'
            priorityTarget = nil -- Если нет целей, сбрасываем приоритет
        end
    end
end)

repeat
    wait()
    if ESP_ENABLED == true then
        FIND()
    end
until ESP_ENABLED == false
